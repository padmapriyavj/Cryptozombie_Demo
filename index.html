<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CryptoZombies DApp</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
    <script src="cryptozombies_abi.js"></script>
    <style>
       body {
    background-color: #1c1c1c; 
    color: #ffd700; 
}
.card {
    background-color: #2e2e2e; 
    color: white;
    border: 2px solid #ffd700; 
}
.btn-custom {
    background-color: #ffd700; 
    color: black;
    font-weight: bold;
    border: none;
}
.btn-custom:hover {
    background-color: #ffcc00; 
}
.alert-warning {
    background-color: #000;
    color: #ffd700;
    border: 1px solid #ffd700;
}



    </style>
</head>
<body>

<div class="container mt-4">
    <h1 class="text-center">üßü‚Äç‚ôÇÔ∏è CryptoZombies DApp</h1>

    <div class="alert alert-warning text-center" id="txStatus">Waiting for transaction...</div>

    <div class="row">
        <div class="col-md-4">
            <button class="btn btn-custom w-100 my-2 showZombieButton">Show Zombies</button>
            <button class="btn btn-custom w-100 my-2 createzombieButton">Create Zombie</button>
            <button class="btn btn-custom w-100 my-2 levelupButton">Level Up</button>
        </div>
        <div class="col-md-8">
            <div id="zombies" class="card p-3">
                <h3 class="text-center">Zombie Collection</h3>
                <div class="list-group" id="zombieList"></div>
            </div>
        </div>
    </div>
</div>

<script>
    var cryptoZombies;
    var userAccount;
    const showZombieButton = document.querySelector('.showZombieButton');
    const createzombieButton = document.querySelector('.createzombieButton');
    const levelupButton = document.querySelector('.levelupButton');

    function startApp() {
        var cryptoZombiesAddress = "0xC08d276D3022F1E9E1e99eBAa6410fE4FcbEcB8f";
        cryptoZombies = new web3.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);

        cryptoZombies.events.Transfer({ filter: { _to: userAccount } })
            .on("data", function (event) {
                let data = event.returnValues;
                getZombiesByOwner(userAccount).then(displayZombies);
            }).on("error", console.error);
    }

    function displayZombies(ids) {
        $("#zombieList").empty();
        for (let id of ids) {
            getZombieDetails(id).then(function (zombie) {
                $("#zombieList").append(`<div class="zombie">
                    <ul>
                        <li>Name: ${zombie.name}</li>
                        <li>DNA: ${zombie.dna}</li>
                        <li>Level: ${zombie.level}</li>
                        <li>Wins: ${zombie.winCount}</li>
                        <li>Losses: ${zombie.lossCount}</li>
                        <li>Ready Time: ${zombie.readyTime}</li>
                    </ul>
                </div>`);

                // Update the zombie image based on its level
                updateZombieImage(zombie.level);
            });
        }
    }

    function createRandomZombie(name) {
        $("#txStatus").text("Creating new zombie on the blockchain. This may take a while...");
        return cryptoZombies.methods.createRandomZombie(name)
            .send({ from: userAccount })
            .on("receipt", function (receipt) {
                $("#txStatus").text("Successfully created " + name + "!");
                getZombiesByOwner(userAccount).then(displayZombies);
            })
            .on("error", function (error) {
                $("#txStatus").text(error);
            });
    }

    function levelUp(zombieId) {
        $("#txStatus").text("Leveling up your zombie...");
        return cryptoZombies.methods.levelUp(zombieId)
            .send({ from: userAccount, value: web3.utils.toWei("0.001", "ether") })
            .on("receipt", function (receipt) {
                $("#txStatus").text("Power overwhelming! Zombie successfully leveled up");

                getZombieDetails(zombieId).then((zombie) => {
                    updateZombieImage(zombie.level);
                });

            })
            .on("error", function (error) {
                $("#txStatus").text(error);
            });
    }

    function updateZombieImage(level) {
        let zombieImage = getZombieImage(level);
        let imgElement = document.getElementById("zombieImage");
        imgElement.classList.remove("show");

        setTimeout(() => {
            imgElement.src = zombieImage;
            imgElement.classList.add("show");
        }, 500);
    }

    function getZombieImage(level) {
        if (level == 1) {
            return "zombie1.png";
        } else if (level == 2) {
            return "zombie2.png";
        } else if (level == 3) {
            return "zombie3.png";
        } else {
            return "zombie4.png";
        }
    }

    function getZombieDetails(id) {
        return cryptoZombies.methods.zombies(id).call();
    }

    function getZombiesByOwner(owner) {
        return cryptoZombies.methods.getZombiesByOwner(owner).call();
    }

    window.addEventListener('load', async () => {
        if (window.ethereum) {
            window.web3 = new Web3(ethereum);
            try {
                const accounts = await ethereum.enable();
                userAccount = accounts[0];
                startApp();
            } catch (error) {}
        } else if (window.web3) {
            window.web3 = new Web3(web3.currentProvider);
            userAccount = web3.eth.accounts[0];
            startApp();
        } else {
            console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
        }
    });

    ethereum.on('accountsChanged', (accounts) => {
        window.location.reload();
    });

    ethereum.on('chainChanged', (chainId) => {
        window.location.reload(); 
    });

    createzombieButton.addEventListener('click', () => {
        createRandomZombie(userAccount);
    });

    showZombieButton.addEventListener('click', () => {
        getZombiesByOwner(userAccount).then(displayZombies);
    });

    levelupButton.addEventListener('click', () => {
        getZombiesByOwner(userAccount).then(levelUp);
    });

</script>
</body>
</html>
 